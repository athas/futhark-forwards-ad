\documentclass[a4paper]{report}
\usepackage{mathpartir}
\usepackage{mathpazo}
\usepackage{amssymb,amsthm,amsmath,amsfonts}
\usepackage{graphicx,color}
\usepackage{booktabs}
\usepackage{listings}
\usepackage[shortlabels]{enumitem}
\usepackage[margin=1.0in, marginparwidth=2in]{geometry}

\input{futhark.tex}

%\newcommand{\ttb}[1]{\texttt{\bf #1}}
%\newcommand{\Loop}[5]{\ttb{loop}~#1=#2~\ttb{for}~#3<#4~\ttb{do}~#5}
\newcommand{\ctx}[2]{#1 ~{\parallel}~ #2}
\newcommand{\ctxa}[3]{#1 \vdash #2 ~{\parallel}~ #3}
\newcommand{\ctxb}[2]{#1 \vdash #2}
\newcommand{\LoopR}[5]{\kw{loop}~#1~\texttt{=}~#2~\kw{for}~#3=#4~\kw{to}~0~\kw{do}~#5}
\newcommand{\update}[2]{#1\mathrel{+}=#2}
\newcommand\doubleplus{+\kern-1.3ex+\kern0.8ex}

\begin{document}
\[
\begin{array}{lcl}
  \id{bop} & ::= & \kw{+} ~~|~~ \kw{-} ~~|~~ \kw{*} ~~|~~ \kw{/} ~~|~~ \kw{<} ~~|~~ \cdots \\
  \id{op} & ::= & \Transpose ~~|~~ \Rearrange~\Par{d,\cdots{},d} ~~|~~ \Replicate \\
  \id{soac} & ::= & \Map ~~|~~ \Reduce ~~|~~ \Scan ~~|~~ \Redomap ~~|~~ \Scanomap\\
  e & ::= & x ~~|~~ d ~~|~~ b ~~|~~ \Par{e,\cdots{},e} ~~|~~ e\SqPar{e} ~~|~~ e~\id{bop}~e
      ~~|~~ \id{op}~e~\cdots{}~e \\
  & |   & \Loop{x_1~\cdots{}~x_n}{e}{y}{e}{e} \\
    & |   & \LoopR{x_1~\cdots{}~x_n}{e}{y}{e}{e} \\
    & |   & \Let{x_1~\cdots{}~x_n}{e}{e} ~~|~~ \If{e}{e}{e} \\
    & |   & \id{soac} ~f~ e~\cdots{}~e \\
  f & ::= & \FnU{x_1~\cdots{}~x_n}{e} ~~|~~ ~~\id{soac}~f~e~\cdots{}~e ~~|~~ e~\id{bop} ~~|~~ \id{bop}~e
\end{array}
\]

\section*{Reverse-mode Rules}
We define \emph{tape maps} ($\parallel \Omega$) and \emph{adjoint contexts} $(\Lambda \vdash)$ as

\[
\begin{array}{lcl}
  \Omega ::= \varepsilon ~~|~~ \Omega, (x \mapsto x_{s}) \\
  \Lambda ::= \varepsilon ~~|~~ \Lambda, (x \mapsto \hat{x})
\end{array}
\]

\subsection*{Forward pass ($\Rightarrow_F$)} 
\begin{figure}[!h] 
\centering
\fbox{
\begin{mathpar}
\inferrule* [right=FwdLoop]
 {
 e = \Loop{\seq{x}}{e_0}{y}{e_n}{e_{body}} \\
  x_{s_0}~\text{fresh} \\
  x_{s_0} = \Replicate~e_n~{\mathbf 0}
}
{
 e \Rightarrow_{F}  \ctx{\Loop{(\seq{x}, x_{s})}{(e_0, x_{s_0})}{y}{e_{n}}{(e_{body}, x_s[y] = \seq{x})}}{(x \mapsto x_{s_0})}
}

\inferrule* [right=FwdIFE]
{
  \If{e_p}{e_t}{e_f}
  e_t \Rightarrow_F \ctx{e_t'}{\Omega_t}
  e_f \Rightarrow_F \ctx{e_f'}{\Omega_f}
}
{
  \If{e_p}{e_t}{e_f} \Rightarrow_F \ctx{\If{e_p}{e_t'}{e_f'}}{\Omega_t \cup \Omega_f}
}
\end{mathpar}
}
\end{figure}

\subsection*{Reverse pass ($\Lleftarrow$)} 
\begin{figure}[!h] 
\centering
\fbox{
\begin{mathpar}
\inferrule* [right=RevLoop]
            {
              e_{body} = \Let{\seq{rs}}{e_{body}'}{\seq{rs}} \\
  e_{loop} = \Let{\seq{lres}}{\Loop{\seq{x}}{e_0}{y}{e_n}{e_{body}}}{\seq{lres}}\\
  e_{loop} \Rightarrow_F \ctx{e_{loop}'}{\Omega} \\
  \seq{fv} = FV(e_{body}) \setminus \seq{x} \\
  \seq{\hat{x}},~ \seq{\hat{fv}},~\seq{\hat{rs}} ~fresh \\
  reset = \Map~(\fn\_.~\mathbf 0)~\seq{\hat{x}} \\
  \Lambda_1' = \Lambda_1,~\seq{x} \mapsto \seq{\hat{x}},~\seq{fv} \mapsto \seq{\hat{fv}},~\seq{rs} \mapsto \seq{\hat{rs}} \\
  \hat{e}_{body} = \Let{\seq{\hat{rs}'}}{\hat{e}_{body}'}{\seq{\hat{rs}'}} \\
  (\ctxb{\Lambda_1'}{e_{body}}) \Lleftarrow (\ctxb{\Lambda_2}{\hat{e}_{body}}) \\
 % \Delta_{FV} = FV(e_{body}) \cap dom(\Lambda_2 \setminus \Lambda_1) \\
  \hat{e}_{body}' = \Let{\seq{rs}}{\Omega[y]}{(\Let{\seq{\hat{rs}'}}{\hat{e}_{body}'}{(reset, \seq{\hat{rs}'}, \seq{fv}}))} \\
 % (\ctxa{\Lambda_2}{\Let{\seq{x}}{e_0}{\seq{x}}}{\varepsilon}) \Lleftarrow  (\ctxa{\Lambda_3}{\Let{\seq{\hat{x}}}{\hat{e}_0}{\seq{x}}}{\varepsilon}) \\
  \widehat{init} = (reset,\Lambda_1[\seq{lres}], \Lambda_1[\seq{fv}]) \\
  \hat{e}_{loop} = {\LoopR{(\seq{\hat{x}},\seq{\hat{rs}}, \seq{\hat{fv}})}{\widehat{init}}{y}{e_n - 1}{\hat{e}_{body}}}\\
  \Lambda_3 = \Lambda_1, \seq{fv} \mapsto \seq{\hat{fv}}
}
            {
                    \ctxb{\Lambda_1}{e_{loop}}
                    \Lleftarrow \left(\ctxb{\Lambda_3}{\Let{(\seq{\hat{x}'},\seq{\hat{rs}'}, \seq{\hat{fv}'})}{\hat{e}_{loop}}{(\Let{\seq{\hat{fv}'}}{\seq{\hat{fv}} + \seq{\hat{rs}'}}{\seq{\hat{fv}'}})}}\right)\\
            }

\inferrule* [right=RevIFE]
            {
  \ctxb{\Lambda}{e_t} \Lleftarrow \ctxb{\Lambda_t}{\Let{\seq{\hat{fv}}_t}{\hat{e}_t}}{\seq{\hat{fv}}_t}\\
  \ctxb{\Lambda}{e_f} \Lleftarrow \ctxb{\Lambda_f}{\Let{\seq{\hat{fv}}_f}{\hat{e}_f}}{\seq{\hat{fv}}_f}\\
  \Lambda_{\Delta_t} = \Lambda \setminus \Lambda_t \\
  \Lambda_{\Delta_f} = \Lambda \setminus \Lambda_f \\
  \seq{\hat{fv}}~ fresh \\
  %\Lambda_{\cup} = \Lambda_{\Delta_t} \cup \Lambda_{\Delta_f} \\
  %\Lambda_t' = \Lambda_{\cup}\left[dom(\Lambda_{\Delta_f}) \mapsto \Lambda\left[dom(\Lambda_{\Delta f})\right]\right]\\
  %\Lambda_f' = \Lambda_{\cup}\left[dom(\Lambda_{\Delta_t}) \mapsto \Lambda\left[dom(\Lambda_{\Delta t})\right]\right]\\
  \hat{e}_t' = \Let{\seq{\hat{fv}}}{sort(\seq{\hat{fv}}_t ~ \doubleplus ~ im(\Lambda_{\Delta_f} - \Lambda_{\Delta_t}))}{(\Let{\seq{\hat{fv}}_t}{\hat{e}_t}{\seq{\hat{fv}}_t})} \\
  \hat{e}_f' = \Let{\seq{\hat{fv}}}{sort(\seq{\hat{fv}}_f ~ \doubleplus ~ im(\Lambda_{\Delta_t} - \Lambda_{\Delta_f}))}{(\Let{\seq{\hat{fv}}_f}{\hat{e}_f}{\seq{\hat{fv}}_f})} \\
  \Lambda' = \Lambda, ~dom(\Lambda_{\Delta_t} \cup \Lambda_{\Delta_f}) \mapsto \seq{\hat{fv}}
}
{
  \ctxb{\Lambda}{\If{e_p}{e_t}{e_f}}\Lleftarrow \ctxb{\Lambda'}{\If{e_p}{\hat{e}_t'}{\hat{e}_f'}}
}
\end{mathpar}
}
\end{figure}

\end{document}
